---
title: 'OHIBC: data_prep_spp.Rmd'
output: 
  html_document:
    toc: true
    theme: spacelab
    highlight: haddock
  pdf_document:
    toc: true
---
``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(sp)        # the classes and methods that make up spatial ops in R
library(rgdal)
library(raster)
library(data.table)

source('~/github/ohibc/R/common.R')  ### an OHIBC specific version of common.R

dir_anx <- file.path(dir_neptune_data, 'git-annex/bcprep') ### git-annex: goal-specific large files
dir_anx_global <- file.path(dir_neptune_data, 'git-annex/globalprep/SPP_ICO')
dir_git <- '~/github/ohibc/spp_ico'
dir_rgn <- '~/github/ohibc/regions'  ### github: general buffer region shapefiles

dir_data_am    <- file.path(dir_neptune_data, 'git-annex/globalprep/_raw_data', 'aquamaps/v2014') 
dir_data_iucn  <- file.path(dir_neptune_data, 'git-annex/globalprep/_raw_data', 'iucn_spp') 

scenario <- 'v2016'

source('~/github/ohibc/R/poly_plot_scores.R')
source(file.path(dir_git, 'R/spp_fxn.R'))
source(file.path(dir_git, 'R/ico_fxn.R'))
# SPP-specific and ICO-specific functions

source('~/github/ohibc/R/prov.R')      
### Provenance tracking functions: must source at start to initialize prov_track
dir_prov <- file.path(dir_git, 'prov') 
### set a provenance folder for this script
this_script_file <- file.path(dir_git, 'data_prep_ico.Rmd')
### set the filename of this script for the provenance functions...



### set up proj4string options: BC Albers and WGS84
p4s_opts <- c('EPSG:3005 NAD83/BC Albers' = '+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0',
              'EPSG:4326 WGS 84'          = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0')
p4s_bcalb <- p4s_opts[1]
```


### get master list of Iconic Species

Get list of all species listed as "iconic" for BC.  For now, use global list.
Attach spp_all_bcsee df to get IUCN category, trend, and NS gl/pr rank

``` {r read iconic species list, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
ico_list_file <- file.path(dir_git, scenario, 'ico_list_ohibc.csv')
message(sprintf('Reading OHIBC iconic species list from: \n  %s\n', ico_list_file))
ico_list_raw <- read.csv(ico_list_file, stringsAsFactors = FALSE) %>%
  select(rgn_name   = Country, 
         comname    = Specie.Common.Name,  
         sciname    = Specie.Scientific.Name, 
         ico_flag   = Flagship.Species,
         ico_local  = Priority.Species_Regional.and.Local,
         ico_global = Priority.Species_Global,
         ico_rgn    = Nation.Specific.List
  )
# clean up names
ico_list_raw <- ico_list_raw %>%
  mutate(rgn_name = str_trim(rgn_name),
         sciname  = str_trim(sciname),
         comname  = str_trim(comname)) %>%
  filter(sciname != '')  

# ditch local species except where rgn_name == 'Canada', then ditch global and regional flags.
ico_list <- ico_list_raw %>%
  filter(is.na(ico_local) | rgn_name == 'Canada') %>%
  select(comname, sciname) %>%
  unique()

### SPP data_prep reads global spp_all, appends BC NatureServe ranks, and
### saves to OHIBC goal directory.  This function uses that updated file.
### NOTE: Category score already accounts for status_pr_score by now.
spp_all <- read.csv(file.path(dir_git, scenario, 'int/spp_all_bcsee.csv'), 
                    stringsAsFactors = FALSE)

# join ico_list to spp_all to incorporate category info and parent/subpop info.
ico_list <- ico_list %>%
  left_join(spp_all %>%
              select(sciname, am_sid, iucn_sid, 
                     popn_trend, popn_category, category_score, trend_score, 
                     status_gl, status_pr, status_gl_score, status_pr_score),
            by = 'sciname')
ico_list <- ico_list %>%
  filter(!is.na(popn_category) | !(is.na(status_pr)))
```

### Find ICO regions for all species on ICO list -----

Using same raster method as for SPP, identify .5 deg cells within BC regions.
Then filter IUCN and AM lists to just species on ico_list, and just cells within BC regions.

``` {r find ico by cell, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

### Read in OHIBC polygons, in WGS84 CRS
dir_rgn <- '~/github/ohibc/regions'
rgn_lyr <- 'ohibc_rgn_wgs84'

cat(sprintf('Reading OHIBC regions shapefile...\n  %s/%s.shp', dir_rgn, rgn_lyr))
poly_bc_rgn <- readOGR(dsn = path.expand(dir_rgn), layer = rgn_lyr,
                       verbose = FALSE, stringsAsFactors = FALSE)

rgn_p4s <- proj4string(poly_bc_rgn)
names(rgn_p4s) <- names(p4s_opts[p4s_opts == rgn_p4s])
message(sprintf('Region loaded: CRS = %s \n  (%s)\n', names(rgn_p4s), rgn_p4s))

rgn2cell_list <- spp_rgn2cell(poly_bc_rgn, reload  = FALSE)

rgn2cell_df      <- rgn2cell_list[[1]]
loiczid_rast     <- rgn2cell_list[[2]]

am_cells_spp   <- spp_get_am_cells(rgn2cell_df, n_max = -1, prob_filter = 0, reload = FALSE)
iucn_cells_spp <- spp_get_iucn_cells(rgn2cell_df)

iucn_ico_bc <- iucn_cells_spp %>%
  filter(sciname %in% ico_list$sciname) %>%
  select(rgn_id, loiczid, rgn_name, sciname) %>%
  mutate(sp_source = 'iucn') %>%
  unique()
### 3413 species/cell combinations

am_ico_bc <- am_cells_spp %>%  
  left_join(spp_all %>% 
              select(am_sid, sciname), 
            by = 'am_sid') %>%
  filter(sciname %in% ico_list$sciname) %>%
  select(rgn_id, loiczid, rgn_name, sciname) %>%
  mutate(sp_source = 'am') %>%
  unique()
### 6682 species/cell combinations.  Note here: I am allowing both 
### IUCN and Aquamaps datasets to indicate presence of an iconic species
### in a given cell... no preference.

ico_bc_cell_rgn <- rbind(iucn_ico_bc, am_ico_bc) %>%
  left_join(spp_all %>%
              filter(!str_detect(spatial_source, 'subpop') &
                     !str_detect(spatial_source, 'alias')) %>%
              select(sciname, category_score, trend_score),
            by = 'sciname')
ico_bc_rgn <- ico_bc_cell_rgn %>%
  select(-loiczid, -sp_source) %>%
  unique()
```

### Map of species count by cell

``` {r plot species count raster, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE, fig.height = 4, fig.width = 6, fig.align = 'center'}
ico_bc_cells <- ico_bc_cell_rgn %>%
  select(-rgn_id, -rgn_name, -sp_source) %>%
  unique()

ico_summary_cells <- ico_bc_cells %>%
  group_by(loiczid) %>%
  summarize(n_ico = n(), 
            mean_cat = mean(category_score, na.rm = TRUE), 
            mean_trend = mean(trend_score, na.rm = TRUE)) %>%
  as.data.frame()

spp_plot_raster(ico_summary_cells, loiczid_rast, which_id = 'n_ico', 
                poly_rgn = poly_bc_rgn,
                title = 'Iconic Species count', scale_label = 'ico count', 
                scale_limits = c(0, max(ico_summary_cells$n_ico)))


```

## Summarize mean category/trend per cell/region, IUCN

For each raster cell, we generate a summary of number of species included, average extinction risk score of all species in cell, and average trend score of all species in cell with population trend information.  This section calculates extinction risk score based solely on IUCN category ranks, which excludes subpopulation scores due to lack of spatially explicit distribution info for subpopulations.

From raster-level summaries, we generate a region-level summary based on area-weighted average extinction risk and population trend.

``` {r summing by cells and rgn, echo = FALSE, message = FALSE, warning = FALSE}

ico_summary_rgn <- ico_bc_rgn %>%
  group_by(rgn_id, rgn_name) %>%
  summarize(n_ico = n(), 
            mean_cat = mean(category_score, na.rm = TRUE), 
            mean_trend = mean(trend_score, na.rm = TRUE)) %>%
  as.data.frame()

knitr::kable(ico_summary_rgn,
             caption = 'summary by region')

DT::datatable(ico_summary_cells,
              caption = 'summary by LOICZID (head)',
              filter = 'bottom')

```


### Map of mean extinction risk category and population trend by cell

*Category value range: least concern = 0, extinct = 1*

*Trend value range: population increasing = +0.5, stable = 0, decreasing = -0.5*

``` {r plot cell score raster, echo = FALSE, message = FALSE, warning = FALSE, cache = TRUE,  fig.height = 4, fig.width = 6, fig.align = 'center'}

spp_plot_raster(ico_summary_cells, loiczid_rast, which_id = 'mean_cat', 
                poly_rgn = poly_bc_rgn,
                title = 'Iconic Species mean rank', scale_label = 'ico rank', 
                scale_limits = c(min(ico_summary_cells$mean_cat), max(ico_summary_cells$mean_cat)),
                rev_scale = TRUE)

spp_plot_raster(ico_summary_cells, loiczid_rast, which_id = 'mean_trend', 
                poly_rgn = poly_bc_rgn,
                title = 'Iconic Species mean trend', scale_label = 'ico trend', 
                scale_limits = c(min(ico_summary_cells$mean_trend), max(ico_summary_cells$mean_trend)))

```

-----
  
## Create final output files

From the region-level summaries of extinction risk and population trend, we calculate regional status and trend scores.  

``` {r save status and trend, echo = FALSE, message = FALSE, warning = FALSE}

ico_status <- ico_summary_rgn %>%
  mutate(score = 1 - mean_cat) %>%
  select(rgn_id, score)
ico_trend <- ico_summary_rgn %>%
  select(rgn_id, score = mean_trend)

cat(sprintf('Writing ICO status and trend to:\n  %s\n  %s\n', 
            file.path(dir_git, scenario, 'data/ico_status.csv'),
            file.path(dir_git, scenario, 'data/ico_trend.csv')))

write_csv(ico_status, file.path(dir_git, scenario, 'data/ico_status.csv'))
write_csv(ico_trend,  file.path(dir_git, scenario, 'data/ico_trend.csv'))

```

## Plot map of status by region

``` {r plot scores as polygons, echo = FALSE, message = FALSE, cache = TRUE, fig.height = 4, fig.width = 6, fig.align = 'center'}

knitr::kable(ico_status %>% 
               left_join(poly_bc_rgn@data, by = 'rgn_id') %>%
               mutate(score = score*100),
  align = c('c', 'c', 'l', 'c', 'r', 'r'),
  caption = 'ICO Status by region:')

poly_plot_scores(ico_status %>% mutate(score = score*100), scale_label = 'ICO Status', title = 'OHIBC ICO Status')

knitr::kable(ico_status %>% left_join(poly_bc_rgn@data, by = 'rgn_id'),
  align = c('c', 'c', 'l', 'c', 'r', 'r'),
  caption = 'ICO Trend by region:')

poly_plot_scores(ico_trend, scale_label = 'ICO Trend', title = 'OHIBC ICO Trend', scale_limits = c(min(ico_trend$score), 0))

```

-----

# Provenance

``` {r provenance info, echo = FALSE, message = FALSE}
### At the start of the script, make sure to: 
### * source 'R/prov.R' for script_prov() and git_prov() functions
### * identify a dir_prov location (this must happen before script_prov() is called)

x <- script_prov(this_script_file)
```

* *Run ID:*
    * *`r x$run_id`*
* *System info:*
    * *`r x$msg_sys`*
* *Session info:*
    * *`r x$msg_ses`*
    * *`r x$msg_base_pcks`*
    * *`r x$msg_att_pcks`*
* *Git commit info:*
    * *`r x$msg_git`*
    
``` {r echo = FALSE}

knitr::kable(prov_track[ , 1:7],   ### does not display system and session info
             caption = 'Provenance summary for this run:')

```
