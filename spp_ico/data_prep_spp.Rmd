---
title: 'OHIBC: data_prep_spp.Rmd'
output: 
  html_document:
    toc: true
    theme: spacelab
    highlight: haddock
  pdf_document:
    toc: true
---
``` {r setup, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
library(sp)        # the classes and methods that make up spatial ops in R
library(rgdal)
library(raster)
library(data.table)

source('~/github/ohibc/R/common.R')  ### an OHIBC specific version of common.R
source('~/github/ohibc/R/poly_plot_scores.R')
dir_anx <- file.path(dir_neptune_data, 'git-annex/bcprep') ### git-annex: goal-specific large files
dir_anx_global <- file.path(dir_neptune_data, 'git-annex/globalprep/SPP_ICO')
dir_git <- '~/github/ohibc/spp_ico'
dir_rgn <- '~/github/ohibc/regions'  ### github: general buffer region shapefiles

scenario <- 'v2016'

source(file.path(dir_git, 'R/spp_fxn.R'))


### set up proj4string options: BC Albers and WGS84
p4s_opts <- c('EPSG:3005 NAD83/BC Albers' = '+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0',
              'EPSG:4326 WGS 84'          = '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0')
p4s_bcalb <- p4s_opts[1]
```
*Compiled on `r date()`*

## Data sources

AquaMaps: <citation>

description

IUCN Red List spatial data: species range map shapefiles

* Shapefiles downloaded from: http://www.iucnredlist.org/technical-documents/spatial-data
* Citation: IUCN 2014. The IUCN Red List of Threatened Species. Version 2014.1. <http://www.iucnredlist.org>. Downloaded on 21 September 2015.

IUCN Red List species index: list of all IUCN red list species, incl IUCN species ID and extinction risk category
* Index .csv downloaded from: http://api.iucnredlist.org/index/all.csv
* Habitat and subpopulation information, by species, scraped from: http://www.iucnredlist.org/details/<species ID>/0
* Citation: IUCN 2015. The IUCN Red List of Threatened Species. Version 2015-3. <http://www.iucnredlist.org>. Downloaded on 9 September 2015.

BC Species and Ecosystems Explorer: <citation>
main site: http://www.env.gov.bc.ca/atrisk/toolintro.html
global, national, state/province assessment: http://explorer.natureserve.org/ranking.htm#global


## Load species lookup table

Currently this uses the global species lookup table. How this list is generated (file locations are in `~/github/ohiprep/globalprep/SPP_ICO`):

* in `ingest_iucn.R`:
    * Pull full IUCN list from http://api.iucnredlist.org/index/all.csv
    * Filter the list to marine species as indicated on each species page
    * Standardize old extinction risk categories
    * Append population trend and parent/subpop info from species web pages
    * Write to `spp_iucn_mar.csv` in git-annex.
* in `spp_fxn.R::create_spp_master_lookup()`:
    * Pull in Aquamaps species information table, create sciname field and standardize categories
    * Pull in IUCN marine species info from `ingest_iucn.R`
    * `full_join()` the two species lists
    * Determine overall category, trend, and spatial info source (preferring IUCN)
    * Remove duplicate records and data-deficient records
    * Convert text extinction risk category and popn trends to number values
    * Identify parent/subpopulations and aliases within `spatial_source` field.

``` {r read global species list, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
spp_global_file <- file.path(dir_anx_global, '/v2015/intermediate/spp_all.csv')
spp_all <- read.csv(spp_global_file, stringsAsFactors = FALSE)
git_prov(spp_global_file)

glimpse(spp_all)
```

## Append BC-specific species risk assessment codes

Data downloaded from BC Species and Ecosystems Explorer includes information on global status and provincial status for species, as assessed by NatureServe.

See [this table]('iucn_to_ns.html') for info on NatureServe codes

``` {r append bcsee scores, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}

spp_all <- spp_append_bcsee(spp_all)

### for this iteration: overwrite IUCN global scores with BCSEE provincial scores.
spp_all_bcsee <- spp_all %>%
  mutate(category_score = ifelse(!is.na(status_pr_score), status_pr_score, category_score))

### for this iteration: overwrite IUCN global scores with BCSEE provincial
### scores (preferred) or global (second choice).
# spp_all_bcsee <- spp_all %>%
#   mutate(category_score = ifelse(!is.na(status_gl_score), status_gl_score, category_score),
#          category_score = ifelse(!is.na(status_pr_score), status_pr_score, category_score))

```


## Define assessment regions 

Using OHIBC region polygons, determine 0.5Â° raster cells corresponding to each region.

``` {r set up region-to-cell lookup, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

### Read in OHIBC polygons, in WGS84 CRS
dir_rgn <- '~/github/ohibc/regions'
rgn_lyr <- 'ohibc_rgn_wgs84'

cat(sprintf('Reading OHIBC regions shapefile...\n  %s/%s.shp', dir_rgn, rgn_lyr))
poly_bc_rgn <- readOGR(dsn = path.expand(dir_rgn), layer = rgn_lyr,
                       verbose = FALSE, stringsAsFactors = FALSE)
git_prov(sprintf('%s/%s.shp', dir_rgn, rgn_lyr))

rgn_p4s <- proj4string(poly_bc_rgn)
names(rgn_p4s) <- names(p4s_opts[p4s_opts == rgn_p4s])
message(sprintf('Region loaded: CRS = %s \n  (%s)\n', names(rgn_p4s), rgn_p4s))

rgn2cell_list <- spp_rgn2cell(poly_bc_rgn, reload  = FALSE)

rgn2cell_df      <- rgn2cell_list[[1]]
loiczid_rast     <- rgn2cell_list[[2]]
```

### Map of region ID per cell

*Note that `subs()` can't deal with duplicate cell IDs; for cells included in two or more regions get the minimum region ID value*

``` {r plot regions raster, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, cache = TRUE}

rgn2cell_clean <- rgn2cell_df %>% 
  group_by(loiczid) %>% 
  summarize(rgn_id = min(rgn_id)) %>% 
  as.data.frame()

spp_plot_raster(rgn2cell_clean, loiczid_rast, which_id = 'rgn_id', 
                poly_rgn = poly_bc_rgn,
                title = 'Region ID', scale_label = 'rgn_id', 
                scale_limits = range(rgn2cell_clean$rgn_id))


```

## Generate species per cell tables for Aquamaps and IUCN

These species-per-cell tables are generated from global SPP goal data, filtered to just OHIBC regions.

``` {r AM species summary, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

am_cells_spp <- spp_get_am_cells(rgn2cell_df, n_max = -1, prob_filter = 0, reload = FALSE)

am_cells_sum <- spp_am_cell_summary(rgn2cell_df, am_cells_spp, spp_all, fn_tag = '', reload = FALSE)
am_cells_sum_bcsee <- spp_am_cell_summary(rgn2cell_df, am_cells_spp, spp_all_bcsee, fn_tag = 'bcsee', reload = TRUE)

cat('Aquamaps cell summary: quick check\n')
glimpse(am_cells_sum)

```

``` {r IUCN species summary, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

iucn_cells_spp <- spp_get_iucn_cells(rgn2cell_df)

iucn_cells_sum <- spp_iucn_cell_summary(spp_all, iucn_cells_spp, reload = FALSE)
iucn_cells_sum_bcsee <- spp_iucn_cell_summary(spp_all_bcsee, iucn_cells_spp, fn_tag = 'bcsee', reload = TRUE)

cat('IUCN cell summary: quick check\n')
glimpse(iucn_cells_sum)

```

### Map of species count by cell

``` {r plot species count raster, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, cache = TRUE}
cells_sum <- iucn_cells_sum %>%
  select(loiczid, n_cat_iucn = n_cat_species) %>%
  full_join(am_cells_sum %>%
              select(loiczid, n_cat_am = n_cat_species),
            by = 'loiczid') %>%
  mutate(n_cat_am   = ifelse(is.na(n_cat_am), 0, n_cat_am),
         n_cat_iucn = ifelse(is.na(n_cat_iucn), 0, n_cat_iucn),
         n_cat      = n_cat_am + n_cat_iucn) %>%
  as.data.frame()

spp_plot_raster(cells_sum, loiczid_rast, which_id = 'n_cat', 
                poly_rgn = poly_bc_rgn,
                title = 'Species count', scale_label = 'spp count', 
                scale_limits = c(0, max(cells_sum$n_cat)))

```

## Summarize mean category/trend per cell/region, IUCN


``` {r summing by cells and rgn, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

summary_by_loiczid <- spp_calc_cell_means(am_cells_sum, iucn_cells_sum)

summary_by_rgn     <- spp_calc_rgn_means(summary_by_loiczid, rgn2cell_df)

cat('summary by LOICZID: quick check\n')
glimpse(summary_by_loiczid)

cat('summary by region: quick check\n')
glimpse(summary_by_rgn)

```

## Summarize mean category/trend per cell/region, IUCN & BCSEE

``` {r summing by cells and rgn 2, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

sum_by_cell_bcsee <- spp_calc_cell_means(am_cells_sum_bcsee, iucn_cells_sum_bcsee)

sum_by_rgn_bcsee    <- spp_calc_rgn_means(sum_by_cell_bcsee, rgn2cell_df)

cat('summary by LOICZID: quick check\n')
glimpse(sum_by_cell_bcsee)

cat('summary by region: quick check\n')
glimpse(sum_by_rgn_bcsee)

```


### Map of mean extinction risk category value by cell

*Category value range: least concern = 0, extinct = 1*
``` {r plot cell score raster, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, cache = TRUE}

scale_limits = c(min(min(sum_by_cell_bcsee$weighted_mean_cat,  na.rm = TRUE),
                     min(summary_by_loiczid$weighted_mean_cat, na.rm = TRUE)), 
                 max(max(sum_by_cell_bcsee$weighted_mean_cat,  na.rm = TRUE),
                     max(summary_by_loiczid$weighted_mean_cat, na.rm = TRUE)))

spp_plot_raster(as.data.frame(summary_by_loiczid), loiczid_rast, 
                which_id = 'weighted_mean_cat', 
                poly_rgn = poly_bc_rgn,
                title = 'Mean extinction risk, IUCN only', scale_label = 'spp risk', 
                scale_limits = scale_limits,
                rev_scale = TRUE)

spp_plot_raster(as.data.frame(sum_by_cell_bcsee), loiczid_rast, 
                which_id = 'weighted_mean_cat', 
                poly_rgn = poly_bc_rgn,
                title = 'Mean extinction risk, IUCN & BCSEE', scale_label = 'spp risk', 
                scale_limits = scale_limits,
                rev_scale = TRUE)

```

## Create final output files

``` {r save status and trend, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

spp_status <- summary_by_rgn %>%
  select(rgn_id, score = status)
spp_trend <- summary_by_rgn %>%
  select(rgn_id, score = rgn_mean_trend)

cat(sprintf('Writing SPP status and trend based only on IUCN categories to:\n  %s\n  %s\n', 
            file.path(dir_git, scenario, 'data/spp_status.csv'),
            file.path(dir_git, scenario, 'data/spp_trend.csv')))

write_csv(spp_status, file.path(dir_git, scenario, 'data/spp_status.csv'))
write_csv(spp_trend,  file.path(dir_git, scenario, 'data/spp_trend.csv'))

spp_status_bcsee <- sum_by_rgn_bcsee %>%
  select(rgn_id, score = status)
spp_trend_bcsee <- sum_by_rgn_bcsee %>%
  select(rgn_id, score = rgn_mean_trend)

cat(sprintf('Writing SPP status and trend based on IUCN & BCSEE categories to:\n  %s\n  %s\n', 
            file.path(dir_git, scenario, 'data/spp_status_bcsee.csv'),
            file.path(dir_git, scenario, 'data/spp_trend_bcsee.csv')))

write_csv(spp_status, file.path(dir_git, scenario, 'data/spp_status_bcsee.csv'))
write_csv(spp_trend,  file.path(dir_git, scenario, 'data/spp_trend_bcsee.csv'))

```

### Compare scores from IUCN only vs IUCN & BCSEE

Current methodology does not affect trend, only status scores, based on whether NatureServe assessment scores are used to overwrite IUCN extinction risk category scores.

``` {r compare status, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}

status_df <- spp_status %>%
  rename(iucn_score = score) %>%
  full_join(spp_status_bcsee %>%
              rename(bcsee_score = score),
            by = 'rgn_id') %>%
  full_join(poly_bc_rgn@data, by = 'rgn_id')

status_compare_plot <- ggplot(data = status_df, aes(x = iucn_score, y = bcsee_score, color = rgn_code)) + 
  geom_point(size = 5) +
  geom_abline(intercept = 0, slope = 1, color = 'red') +
  coord_fixed(ratio = 1, xlim = c(65, 85), ylim = c(65, 85)) +
  labs(title = 'SPP Status with and without BCSEE provincial assessment data',
       x  = 'Status using IUCN categories only',
       y  = 'Status using IUCN and BCSEE categories')

print(status_compare_plot)

```


## Plot map of status by region

Currently, the Species Richness sub-goal model is identical to the OHI Global model: a region's status is based upon an area-weighted average of IUCN extinction risk.  From Halpern et al (2012):

> The target for the Species sub-goal is to have all species at a risk status of Least Concern. We scaled the lower end of the biodiversity goal to be 0 when 75% species are extinct, a level comparable to the five documented mass extinctions and would constitute a catastrophic loss of biodiversity. The Status of assessed species was calculated as the area- and threat status-weighted average of the number of threatened species within each 0.5 degree grid cell.

$$Y_{cell} = \frac{\displaystyle\sum_{species}(Risk)}{n_{spp}}$$

$$Y_{SPP} = \frac{\displaystyle\sum_{cells}(Y_{cell} * A_{cell} * pA_{cell-rgn})}{A_{rgn}}$$

$$X_{SPP} = \frac{((1 - Y_{SPP}) - 0.25)}{(1 - 0.25)} * 100%$$

where:

* $X_{SPP}$ is Species goal status
* $Y_{cell}$ is mean extinction risk for one cell
* $Y_{SPP}$ is area-weighted mean extinction risk for a region
* $A_{cell}$ is cell area
* $pA_{cell-rgn}$ is percent of cell area included in region
* *Risk* is scaled value for species extinction risk category, based on: 
    * 'LC' = 0.0, 'NT' = 0.2, 'VU' = 0.4, 'EN' = 0.6, 'CR' = 0.8, 'EX' = 1.0
* SPP trend is calculated in a similar area-weighted mean, but population trend values are assigned according to:
    * 'Decreasing' = -0.5, 'Stable' = 0.0, 'Increasing' = +0.5

### OHIBC SPP status and trend by region

``` {r plot scores as polygons, eval = TRUE, echo = FALSE, message = FALSE, cache = TRUE}

print(spp_status)

poly_plot_scores(spp_status, scale_label = 'SPP Status', title = 'OHIBC SPP Status')

print(spp_trend)

poly_plot_scores(spp_trend, scale_label = 'SPP Trend', title = 'OHIBC SPP Trend', scale_limits = c(min(spp_trend$score), 0))

```

## Summarize mean category/trend within 3 nm of shore

Create final outputs for 3nm zone for resilience calculations

``` {r calc 3nm SPP values, eval = TRUE, echo = FALSE, message = FALSE}
### Read in OHIBC 3nm offshore polygons, in WGS84 CRS
rgn_lyr <- 'ohibc_offshore_3nm_wgs84'
cat(sprintf('Reading OHIBC 3nm offshore regions shapefile...\n  %s/%s.shp', dir_rgn, rgn_lyr))
poly_bc_3nm <- readOGR(dsn = path.expand(dir_rgn), layer = rgn_lyr,
                       verbose = FALSE, stringsAsFactors = FALSE)

git_prov(sprintf('%s/%s.shp', dir_rgn, rgn_lyr))

rgn_p4s <- proj4string(poly_bc_3nm)
names(rgn_p4s) <- names(p4s_opts[p4s_opts == rgn_p4s])
message(sprintf('Region loaded: CRS = %s \n  (%s)\n', names(rgn_p4s), rgn_p4s))

rgn2cell_3nm_df <- spp_rgn2cell(poly_bc_3nm, rgn_tag = '_3nm', reload  = TRUE)[[1]]

summary_by_rgn_3nm <- spp_calc_rgn_means(summary_by_loiczid, rgn2cell_3nm_df, rgn_note = '3nm')

spp_status_3nm <- summary_by_rgn_3nm %>%
  select(rgn_id, score = status)
spp_trend_3nm <- summary_by_rgn_3nm %>%
  select(rgn_id, score = rgn_mean_trend)

cat(sprintf('Writing SPP status and trend for 3nm regions to:\n  %s\n  %s\n', 
            file.path(dir_git, scenario, 'data/spp_status_3nm.csv'),
            file.path(dir_git, scenario, 'data/spp_trend_3nm.csv')))
write_csv(spp_status_3nm, file.path(dir_git, scenario, 'data/spp_status_3nm.csv'))
write_csv(spp_trend_3nm,  file.path(dir_git, scenario, 'data/spp_trend_3nm.csv'))

```
