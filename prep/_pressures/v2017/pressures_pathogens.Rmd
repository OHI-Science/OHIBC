---
title: 'OHIBC: Pathogens Pressure layers prep'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = FALSE, message = FALSE, warning = FALSE)

library(sf)

dir_git <- '~/github/ohibc'
source(file.path(dir_git, 'src/R/common.R'))

dir_spatial <- path.expand(file.path(dir_git, 'prep/_spatial'))

### goal specific folders and info
goal      <- '_pressures'
scenario  <- 'v2017'
dir_goal  <- file.path(dir_git, 'prep', goal, scenario)
dir_anx   <- file.path(dir_M, 'git-annex/bcprep')
dir_goal_anx <- file.path(dir_M, 'git-annex/bcprep', goal, scenario)

library(provRmd); prov_setup()

### goal-specific source scripts
source(file.path(dir_goal, 'pressures_lyr_fxns.R'))

### other support functions
source(file.path(dir_git, 'src/R/rast_tools.R'))

reload <- FALSE

```

# Summary

This pressure layer determines potential for human pathogen contamination using census district populations, statistics on percent of population with improved sanitation (by province and by municipality size), and modeled population density.

$$X_{pathogens} = 1 - \frac{N_{sewer}}{N_{total}}$$
where $N_{sewer}$ represents the population in the region on a sewer system (as opposed to septic or store-and-haul).

# Data

__Census subdivision administrative boundaries__

* __Reference__: [Copyright © 2017, Province of British Columbia](http://www2.gov.bc.ca/gov/content/home/copyright)
* __Downloaded__: Aug 7, 2017 from http://www2.gov.bc.ca/gov/content/data/geographic-data-services/land-use/administrative-boundaries
* __Description__:  Census subdivision administrative boundaries
* __Native data resolution__: Census subdivision
* __Format__:  ESRI shapefile

__2011 and 2016 Census Total Population Results Census Subdivisions__

* __Reference__: [Statistics Canada, Prepared by:  BC Stats, Ministry of Technology, Innovation and Citizens' Services]
* __Downloaded__: Aug 7, 2017 from http://www.bcstats.gov.bc.ca/StatisticsBySubject/Census/2011Census/PopulationHousing/CensusSubdivisions.aspx (2011) and http://www.bcstats.gov.bc.ca/StatisticsBySubject/Census/2016Census/PopulationHousing/CensusSubdivisions.aspx (2016)
* __Description__:  Census subdivision populations for 2011 and 2016
* __Native data resolution__: Census subdivision; note boundaries changed between 2011 and 2016.
* __Format__:  .csv

__2001-2011 Population estimates by Municipalities, Regional Districts and Development Regions__

* __Reference__: [Copyright © 2017, Province of British Columbia](http://www2.gov.bc.ca/gov/content/home/copyright)
* __Downloaded__: Aug 7, 2017 from http://www2.gov.bc.ca/gov/content/data/statistics/people-population-community/population/population-estimates
* __Description__:  Census municipality populations for 2001-2011
* __Native data resolution__: Municipality
* __Format__:  .xlsx

__2011 Municipal Water Use Report – Municipal Water Use 2009 Statistics__

* __Reference__: [Copyright © 2017, Province of British Columbia](http://www2.gov.bc.ca/gov/content/home/copyright)
* __Downloaded__: Aug 7, 2017 from http://www.ec.gc.ca/doc/publications/eau-water/COM1454/survey8-eng.htm#table3_toc
* __Description__:  Percent populations served by sewers, by province and by municipality size
* __Native data resolution__: Province and municipality size division
* __Format__:  web page

__National Assessment of First Nations Water and Wastewater Systems - National Roll-Up Report__

* __Reference__: [Indigenous and Northern Affairs Canada](http://www.aadnc-aandc.gc.ca/eng/1100100010002/1100100010021)
* __Downloaded__: Aug 7, 2017 from http://www.aadnc-aandc.gc.ca/eng/1313770257504/1313770328745#tab3_5
* __Description__:  Summary of Overall Risk by Region – Wastewater 
* __Native data resolution__: Province
* __Format__:  web page


# Methods

## Determine populations on various levels of sewer service

Based on the [2011 Municipal Water Use Report](http://www.ec.gc.ca/doc/publications/eau-water/COM1454/survey8-eng.htm#table3_toc) we can approximately determine the population of people in each municipality on various levels of sewer service  (sewer, septic, holding tanks).  Aggregating these up to OHIBC regions allows us to determine region-wide populations served by these methods.

### Determine population of municipalities within OHIBC

Develop a dataframe of municipalities by OHIBC region (inland, based on MaPP inland regions and watershed boundaries).  Census subdivisions will be allocated to OHIBC regions according to area-weighting.



``` {r read_in_data}

ohibc_rgn_sf <- read_sf(dsn = dir_spatial, layer = 'ohibc_rgns_unclipped')

bc_subdiv_sf <- read_sf(file.path(dir_anx, '_raw_data/bcstats/Boundaries - Census Subdivisions 2011'),
                               layer = 'CSD_2011')
bc_subdiv_sf$area_km2 <- st_area(bc_subdiv_sf) / 1e6
# bc_subdiv_sf$valid_check <- st_is_valid(bc_subdiv_sf)
# x <- bc_subdiv_sf %>% filter(valid_check == FALSE)
# plot(x)
# y <- bc_subdiv_sf %>%
#   st_buffer(dist = 0)
# plot(y %>% filter(valid_check == FALSE))
# st_is_valid(y) 
### Because of invalid geometries in the BC census subdiv file, 
### using a zero-distance buffer repairs the geometries.
bc_subdiv_sf <- bc_subdiv_sf %>%
  st_buffer(dist = 0)

subdiv_ohibc_sf <- st_intersection(ohibc_rgn_sf, bc_subdiv_sf)

subdiv_ohibc_sf$ohibc_area_km2 <- st_area(subdiv_ohibc_sf) / 1e6

subdiv_ohibc_df <- subdiv_ohibc_sf %>%
  as.data.frame() %>%
  setNames(tolower(names(.))) %>%
  select(rgn_name, rgn_id, 
         csduid, csdname, csdtype, 
         area_km2, ohibc_area_km2) %>%
  mutate(area_km2 = as.numeric(area_km2),
         ohibc_area_km2 = as.numeric(ohibc_area_km2),
         prop_rgn = round(ohibc_area_km2 / area_km2, 4))

write_csv(subdiv_ohibc_df, file.path(dir_goal, 'int/patho_ohibc_subdiv_area.csv'))

```

Assign 2011 population statistics to each census subdivision; using 2011 rather than 2016 to match administrative boundaries and to better match the sewer service data.  Result is a dataframe of OHIBC region, and population by municipality size category.

The data from the Municipal Waste Water Survey exclude municipalities on federal lands and First Nations communities.  These can be identified from the census data using the "type" codes: 

|CSD type | Description |
| :-----: | :---------- |
|   CY    | City |
|   DM    | District Municipality |
|    T    | Town |
|   VL    | Village |
|   IM    | Island Municipality |
|  IRI ✓  | Indian Reserve |
|  RDA    | Regional District Electoral Area |
|  IGD ✓  | Indian Governmental District |
|  S-E ✓  | Indian Settlement |
|   NL ✓  | Nisga'a Land |
|  NVL ✓  | Nisga'a Village |

``` {r ohibc_pop_by_municipality_size}

subdiv_ohibc_df <- read_csv(file.path(dir_goal, 'int/patho_ohibc_subdiv_area.csv'))

fn_types <- c('IRI', 'IGD', 'S-E', 'NL', 'NVL') %>%
  paste(collapse = '|')

subdiv_pop <- read_csv(file.path(dir_anx, '_raw_data/bcstats',
                                 'Census 2011 Table6_5cb2908c-3bb5-4d64-b47e-a667a478c81f_3.csv')) %>%
  clean_df_names() %>%
  select(sgc, pop_2011 = `2011_population`)

ohibc_pop <- subdiv_ohibc_df %>%
  left_join(subdiv_pop, by = c('csduid' = 'sgc')) %>%
  mutate(pop_2011 = ifelse(is.na(pop_2011), 0, pop_2011),
         pop_cat = case_when(str_detect(csdtype, fn_types) ~ 'First Nations',
                             pop_2011 < 1000   ~ 'Under 1000',
                             pop_2011 < 2000   ~ '1001–2000',
                             pop_2011 < 5000   ~ '2001–5000',
                             pop_2011 < 50000  ~ '5001–50 000',
                             pop_2011 < 500000 ~ '50 001–500 000',
                             TRUE              ~ 'More than 500 000'),
         pop_in_ohibc = round(pop_2011 * prop_rgn))

ohibc_pop_sum <- ohibc_pop %>%
  group_by(rgn_id, pop_cat) %>%
  summarize(pop_in_pop_cat = sum(pop_in_ohibc)) %>%
  ungroup()

DT::datatable(ohibc_pop_sum)

write_csv(ohibc_pop_sum, file.path(dir_goal, 'int/patho_ohibc_pop_in_pop_category.csv'))

```

### Assign sewer service levels to OHIBC regions

Using the population categories, assign proportion of population serviced by sewers, and summarize to OHIBC regions. Unfortunately, only data from the 2011 report is readily available online; links to the MWWS publications page are broken.

The data from the Municipal Waste Water Survey exclude municipalities on federal lands and First Nations communities.  For these municipalities, we have rough information on "high" "medium" and "low" risk systems from National Assessment of First Nations Water and Wastewater Systems report, [Table 3.5 – Summary of Overall Risk by Region – Wastewater](http://www.aadnc-aandc.gc.ca/eng/1313770257504/1313770328745#tab3_5), and a digitized map from [Figure 3.5 – Community Wastewater Systems By Risk](http://www.aadnc-aandc.gc.ca/eng/1313770257504/1313770328745#fig3_5) (note, digitized from the PDF which is at higher resolution than the website).

#### Determine First Nations waste water risk

Using the digitized map, determine spatial allocation of wastewater risk for First Nations to OHIBC regions.  Note, no FNs are present in region 8 according to the map, but also according to the census subdivisions.  This analysis creates a dataframe of mean pressure, indicating a proxy for proportion *not* connected to sewer.

``` {r spatialize_fn_risk}

fn_risk_sf <- read_sf(dsn = file.path(dir_goal, 'raw'),
                      layer = 'patho_fn_wastewater_risk') %>%
  mutate(risk = factor(risk, levels = c('high', 'med', 'low')))
ohibc_rgn <- read_sf(dsn = dir_spatial,
                     layer = 'ohibc_rgns_unclipped') %>%
  mutate(rgn_name = factor(rgn_name,
                           levels = .$rgn_name))

ohibc_rgn_offshore <- read_sf(dsn = dir_spatial,
                              layer = 'ohibc_rgn_simple')
library(tmap)
fn_risk_map <- tm_shape(ohibc_rgn) +
    tm_polygons(col = 'grey60',
                size = .2,
                palette = 'BrBG') +
  tm_shape(ohibc_rgn_offshore) +
    tm_polygons(col = '#ddeeff',
                alpha = .8, size = .2) +
  tm_shape(fn_risk_sf) +
    tm_bubbles(col = 'risk',
               alpha = .7,
               palette = 'RdYlGn',
               border.col = 'grey30')

fn_risk_df <- st_intersection(fn_risk_sf, ohibc_rgn) %>%
  as.data.frame() %>%
  select(id, risk, rgn_name, rgn_id) %>%
  group_by(rgn_id, risk) %>%
  summarize(n_systems = n()) %>%
  group_by(rgn_id) %>%
  mutate(pressure = case_when(risk == 'high' ~ 1.0,
                              risk == 'med'  ~ 0.5,
                              risk == 'low'  ~ 0.0,
                              TRUE           ~ -1)) %>%
  summarize(systems = paste(paste0(risk, ' = ', n_systems), collapse = '; '),
            mean_prs = sum(pressure * n_systems) / sum(n_systems)) %>%
  ungroup()

write_csv(fn_risk_df, file.path(dir_goal, 'int/patho_fn_risk_by_rgn.csv'))

DT::datatable(fn_risk_df)
```

Calculate population served by sewers for non-First Nations (using population %ages from survey), then for First Nations (using mean of high/med/low risk values).  

``` {r pop_served_by_sewers}

pop_sewer <- read_csv(file.path(dir_goal, 'raw', 'patho_pop_served_by_sewers.csv')) %>%
  clean_df_names() %>%
  filter(str_detect(grouping, 'British Columbia|[0-9]')) %>%
  select(grouping, contains('percent')) %>%
  gather(key = class, value = percent, -grouping) %>%
  mutate(class = str_replace_all(class, 'percent_of_the_population_that_is_(served_)?(on_)?', ''),
         percent = str_replace_all(percent, '[^0-9\\.]', ''),
         percent = as.numeric(percent) / 100)

ohibc_pop_sewer <- read_csv(file.path(dir_goal, 'int/patho_ohibc_pop_in_pop_category.csv')) %>%
  filter(pop_cat != 'First Nations') %>%
  left_join(pop_sewer, by = c('pop_cat' = 'grouping')) %>%
  group_by(rgn_id, class) %>%
  summarize(pop_in_class = sum(pop_in_pop_cat * percent)) %>%
  ungroup()

fn_risk <- read_csv(file.path(dir_goal, 'int/patho_fn_risk_by_rgn.csv'))

ohibc_fn_sewer <- read_csv(file.path(dir_goal, 'int/patho_ohibc_pop_in_pop_category.csv')) %>%
  filter(pop_cat == 'First Nations') %>%
  left_join(fn_risk, by = 'rgn_id') %>%
  mutate(class = 'First Nations low risk',
         pop_in_class = pop_in_pop_cat * (1 - mean_prs)) %>%
  select(rgn_id, class, pop_in_class)

ohibc_all_sewer <- bind_rows(ohibc_pop_sewer, ohibc_fn_sewer)

DT::datatable(ohibc_all_sewer)

write_csv(ohibc_all_sewer, file.path(dir_goal, 'int/patho_ohibc_pop_sewer.csv'))

### check population-based score (excluding First Nations) to see how
### proportions match with all-BC proportions

x <- ohibc_pop_sewer %>%
  mutate(n_tot = sum(pop_in_class)) %>%
  group_by(class) %>%
  summarize(calculated_pct = sum(pop_in_class) / first(n_tot) %>%
              round(4))

pop_sewer_check <- read_csv(file.path(dir_goal, 'raw', 'patho_pop_served_by_sewers.csv')) %>%
  clean_df_names() %>%
  filter(str_detect(grouping, 'British Columbia')) %>%
  select(grouping, contains('percent')) %>%
  gather(key = class, value = published_pct, -grouping) %>%
  mutate(class = str_replace_all(class, 'percent_of_the_population_that_is_(served_)?(on_)?', ''),
         published_pct = str_replace_all(published_pct, '[^0-9\\.]', ''),
         published_pct = as.numeric(published_pct) / 100) %>%
  left_join(x, by = 'class')

```


To check assumptions that the municipality-size proportions of sewer service (which represent all Canada) are comparable to the BC-specific published values, compare the calculated sewer percentages for overall BC to the published values:

`r knitr::kable(pop_sewer_check)`

## Calculate pathogen pressures for OHIBC regions

Our pressure model will be based on a goal of having 100% of population on sewer systems (for a pressure of zero).  A region with 100% of people on septic or holding tanks would get a pressure score of 1.

``` {r calc_pressures}

ohibc_sum_sewer <- read_csv(file.path(dir_goal, 'int/patho_ohibc_pop_sewer.csv')) %>%
  group_by(rgn_id) %>%
  mutate(pop_total = sum(pop_in_class)) %>%
  filter(str_detect(class, 'sewer|low risk')) %>%
  summarize(pressure = 1 - sum(pop_in_class) / first(pop_total)) %>%
  ungroup()

write_csv(ohibc_sum_sewer, file.path(dir_goal, 'output', 'prs_pathogens_layer.csv'))

```

-----

``` {r plot_pressures}

ohibc_sum_sewer <- read_csv(file.path(dir_goal, 'output', 'prs_pathogens_layer.csv'))

prs_df <- ohibc_sum_sewer %>%
  left_join(get_rgn_names(), by = 'rgn_id')

# prs_plot <- ggplot(prs_df, aes(x = year, y = pressure, color = rgn_name, group = rgn_name)) +
#   ggtheme_plot() +
#   geom_line(show.legend = FALSE) +
#   scale_color_brewer(palette = 'Dark2') +
#   ylim(0, NA) +
#   facet_wrap( ~ rgn_name) +
#   labs(title = 'Pathogens pressure',
#        x = 'Year',
#        y = 'Rescaled pressure score')

prs_plot <- ggplot(prs_df, aes(x = rgn_name, y = pressure)) +
  ggtheme_plot() +
  geom_bar(stat = 'identity') +
  scale_color_brewer(palette = 'Dark2') +
  theme(axis.text.x = element_text(angle = 22.5)) +
  labs(title = 'Pathogens pressure',
       x = 'Year',
       y = 'Rescaled pressure score')

print(prs_plot)

```

-----

``` {r results = 'asis'}

prov_wrapup(commit_outputs = FALSE)

```
