---
title: 'OHIBC: data prep for wild-capture fisheries: spatializing RAM stocks'
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/ohibc/src/templates/ohibc_hdr1.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'Figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)

library(sp)
library(rgdal)
library(raster)
library(sf)

dir_git <- '~/github/ohibc'
source(file.path(dir_git, 'src/R/common.R'))  ### an OHIBC specific version of common.R
dir_rgn <- file.path(dir_git, 'prep/regions')  ### github: general buffer region shapefiles
dir_anx <- file.path(dir_M, 'git-annex/bcprep')


### goal specific folders and info
goal      <- 'fis'
scenario  <- 'v2017'
dir_goal  <- file.path(dir_git, 'prep', goal, scenario)
dir_goal_anx <- file.path(dir_anx, goal, scenario)
dir_spatial  <- file.path(dir_git, 'prep/_spatial')
dir_dfo_data <- file.path(dir_anx, '_raw_data/dfo_khunter')


### provenance tracking
library(provRmd); prov_setup()

### support scripts
source(file.path(dir_git, 'src/R/rast_tools.R')) 
  ### raster plotting and analyzing scripts

### set up proj4string options: BC Albers and WGS84
p4s_wgs84 <- '+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0'
p4s_bcalb <- '+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0'

```

# Summary

This script collects spatial boundaries for RAM stocks, using stock IDs from the RAM prep script and the boundaries created by Chris Free: https://marine.rutgers.edu/~cfree/ram-legacy-stock-boundary-database/

From this, we generate for each stock a region-by-region proportional area to apportion RAM catch to OHIBC regions.

***

# Data Source

**Reference**: https://marine.rutgers.edu/~cfree/ram-legacy-stock-boundary-database/

**Downloaded**: 7/5/2017

**Description**:  Boundaries for RAM stocks

**Format**:  ESRI shapefile format.

***
  
# Methods

For each RAM stock identified in the script `1_data_prep_fis_ram.Rmd`, identify the appropriate shapefile for boundaries, either from the Chris Free datasets or from DFO (if there is a difference).

## Determine fisheries to analyze

The .zipped set of shapefiles seems to be named according to the RAM `assess_id` field.   Copy the relevant set to `git-annex`, in the `fis/v2017/stock_boundaries/ram` folder.

``` {r get_fisheries_stocks}

stock_list <- read_csv(file.path(dir_goal, 'output/ram_catch.csv')) %>%
  select(stock_id, stock_name, ram_area_id, ram_area_name) %>%
  distinct()

ram_spatial_dir <- file.path(dir_anx, '_raw_data/ram_fisheries/d2017/spatial')
boundary_list <- readxl::read_excel(file.path(ram_spatial_dir, 'ramldb_v3.8_stock_boundary_table_v2_formatted.xlsx')) %>%
  filter(stockid %in% stock_list$stock_id)

shp_list <- list.files(file.path(ram_spatial_dir, 'ramldb_boundaries'), full.names = TRUE)

boundary_list <- boundary_list %>%
  select(assessid, stockid, stocklong, zone_col, zones, notes) %>%
  mutate(dir = file.path(ram_spatial_dir, 'ramldb_boundaries'),
         shp = assessid,
         file_exists = file.exists(file.path(dir, shp)))

x <- lapply(boundary_list$shp, FUN = function(x) {
  ### x <- boundary_list$shp[1]
  file.copy(from = file.path(ram_spatial_dir, 'ramldb_boundaries', paste0(x, c('.shp', '.prj', '.shx', '.dbf'))),
            to = file.path(dir_goal_anx, 'stock_boundaries/ram'))
})

```

## Assign relative stock boundary areas to OHIBC regions

For each RAM stock, intersect the RAM boundary polygons (from Chris Free) with the OHIBC regions, then calculate area (in km^2) within each OHIBC region and proportional areas.  The output layer for toolbox use will simply contain OHIBC region, stock ID, and stock-in-region area in km^2.

``` {r apportion_ram_boundaries_to_ohibc}

ram_bounds_dir <- file.path(dir_goal_anx, 'stock_boundaries/ram')

shp_list <- list.files(ram_bounds_dir, pattern = '.shp$', full.names = FALSE) %>%
  str_replace('.shp$', '')

ohibc_sf <- read_sf(dir_spatial, 'ohibc_rgn') %>%
  st_transform(4326)

intsx_ram <- function(ram_layer) {
  ### ram_layer <- shp_list[53]

  ptm <- proc.time()
  ram_sf <- read_sf(ram_bounds_dir, ram_layer)
  
  intsx_sf <- st_intersection(ohibc_sf, ram_sf) %>%
    select(rgn_name, rgn_id, assessid, stockid)
  
  if(nrow(intsx_sf) > 0) {
    intsx_df <- intsx_sf %>%
      mutate(area_m2 = st_area(geometry)) %>%
      as.data.frame() %>%
      select(-geometry) %>%
      mutate(elapsed = (proc.time() - ptm)[3])
    return(intsx_df)
  } else {
    return((proc.time() - ptm)[3])
  }
}

# ram_ohibc_all_list <- vector('list', length = length(shp_list)) %>%
#   setNames(shp_list)
# for(ram_layer in shp_list) {
#   message(ram_layer)
#   ram_ohibc_all_list[[ram_layer]] <- intsx_ram(ram_layer)
# }

ram_ohibc_all_list <- parallel::mclapply(shp_list, FUN = intsx_ram, mc.cores = 18) %>%
  setNames(shp_list)

ram_ohibc_dfs <- ram_ohibc_all_list[sapply(ram_ohibc_all_list, class) == 'data.frame']
ram_ohibc_all <- ram_ohibc_dfs %>%
  bind_rows() %>%
  group_by(stockid) %>%
  mutate(area_km2 = round(area_m2 / 1e6, 3),
         a_tot    = sum(area_m2),
         a_prop   = round(area_m2 / a_tot, 5)) %>%
  select(-elapsed, -area_m2, -a_tot)

write_csv(ram_ohibc_all, file.path(dir_goal, 'ram', '3_ram_stock_to_ohibc_areas.csv'))

DT::datatable(ram_ohibc_all)
```

``` {r write_output_layer}

ram_ohibc_all <- read_csv(file.path(dir_goal, 'ram', '3_ram_stock_to_ohibc_areas.csv')) %>%
  select(rgn_id, stockid, area_km2)

write_csv(ram_ohibc_all, file.path(dir_goal, 'output', 'ram_stock_area.csv'))

```
-----

``` {r provenance, results = 'asis'}
prov_wrapup(commit_outputs = FALSE)
```
